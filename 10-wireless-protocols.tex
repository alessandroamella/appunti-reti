\input{preambolo_comune}

% --- Titolo ---
\title{Protocolli MAC Wireless}
\author{Basato sulle slide del Prof. Luciano Bononi}
\date{\today}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section{Introduzione al Livello MAC Wireless}
Il livello MAC (Medium Access Control) nei sistemi wireless ha ruoli fondamentali per gestire l'accesso al mezzo trasmissivo condiviso (l'etere).

\subsection{Ruoli del Livello MAC Wireless}
\begin{itemize}
    \item \textbf{Controllo dell'Accesso al Canale Condiviso:}
    \begin{itemize}
        \item La trasmissione wireless è intrinsecamente \textit{broadcast}: tutti nel raggio d'azione possono ricevere.
        \item Questo porta a \textit{collisioni di segnale}: un problema sia temporale (chi trasmette quando) sia spaziale (chi trasmette dove).
        \item \textbf{Obiettivo principale}: Decidere chi trasmette, quando e (in alcuni contesti avanzati) dove.
        \item \textbf{Assenza di Collision Detection (CD)}: A differenza delle reti cablate (Ethernet), nelle reti wireless è difficile per un trasmettitore rilevare una collisione mentre sta trasmettendo. Il segnale emesso è molto più forte di qualsiasi segnale ricevuto, mascherando la collisione. Quindi, si punta sull'evitare le collisioni (\textit{Collision Avoidance - CA}).
    \end{itemize}
    \item \textbf{Utilizzo delle Scarse Risorse:}
    \begin{itemize}
        \item \textit{Capacità del canale (Channel capacity)} e \textit{consumo energetico (battery power)} sono limitati e preziosi. Il MAC deve ottimizzarne l'uso.
    \end{itemize}
    \item \textbf{Performance e QoS (Quality of Service):}
    \begin{itemize}
        \item Il MAC influenza le prestazioni percepite sia a livello di sistema (efficienza generale) sia a livello utente (es. ritardo, throughput per una specifica applicazione).
    \end{itemize}
    \item \textbf{Organizzazione dei Frame e Gestione delle Informazioni:}
    \begin{itemize}
        \item Gestione delle informazioni sia all'interno del livello MAC (\textit{intra-layer}) sia tra livelli diversi (\textit{inter-layer}).
        \item \textit{Cross-layering}: Principi per cui un livello può usare informazioni da altri livelli per ottimizzare il comportamento (es. il MAC usa info dal routing). Comporta il rischio di "spaghetti design" (architetture complesse e difficili da mantenere).
    \end{itemize}
\end{itemize}

\subsection{Collisione dei Segnali Wireless}
\begin{itemize}
    \item \textbf{Effetto Distruttivo sul Ricevitore:} Una collisione rende il segnale incomprensibile al ricevitore, causando spreco di canale (tempo perso) e di energia (trasmissioni inutili).
    \item \textbf{Collision Detection Non Pratica:} Come detto, difficile da implementare.
    \item \textbf{Strategie:}
    \begin{itemize}
        \item \textit{Collision Avoidance/Resolution}: Tecniche per prevenire o risolvere le collisioni.
        \item \textit{Contention Control sul Trasmettitore}: Il trasmettitore adotta meccanismi per ridurre la probabilità di collisione.
    \end{itemize}
    \item \textbf{Effetto Cattura (Capture Effect):}
    \begin{itemize}
        \item Se due segnali arrivano contemporaneamente, ma uno è significativamente più forte dell'altro, il ricevitore potrebbe riuscire a decodificare il segnale più forte.
        \item Può essere sfruttato per migliorare il riuso del canale.
        \item \textit{Esempio Pratico:} Immagina due persone che ti parlano contemporaneamente. Se una ti urla nell'orecchio e l'altra sussurra da lontano, probabilmente capirai chi urla.
    \end{itemize}
    \item \textbf{Dominio di Collisione (Collision Domain):} L'insieme di nodi che condividono lo stesso canale e le cui trasmissioni possono interferire tra loro.
    \begin{itemize}
        \item \textit{Space splitting, transitive relation}: La divisione spaziale e le relazioni transitive definiscono l'estensione del dominio di collisione.
    \end{itemize}
\end{itemize}

\subsection{Diagramma delle Collisioni}
Il diagramma seguente illustra come due domini di trasmissione possono sovrapporsi, creando una zona di potenziale collisione. I segnali diretti ai rispettivi ricevitori (indicati con un punto esclamativo) possono collidere se trasmessi contemporaneamente nello stesso spazio.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=0.8, every node/.style={text=white}]
    % Primo trasmettitore e suo raggio
    \node[text=primarytext] (t1) at (-3,0) {\textbf{Tx1}};
    \node[nodo_testo, color=red, font=\Huge] at (-0.3,-0.6) {\textbf{!}};
    \draw[red, thick] (t1) circle (1.5cm);
    \draw[linea, red, thick] (-1.5,0) -- (-0.3,0) node[pos=0.7, above, nodo_testo, color=red] {Segnale 1};

    % Secondo trasmettitore e suo raggio
    \node[text=primarytext] (t2) at (3,0) {\textbf{Tx2}};
    \node[nodo_testo, color=themeblue, font=\Huge] at (0.3,0.6) {\textbf{!}};
    \draw[themeblue, thick] (t2) circle (1.5cm);
    \draw[linea, themeblue, thick] (1.5,0) -- (0.3,0) node[pos=0.7, below, nodo_testo, color=themeblue] {Segnale 2};

    % Area di sovrapposizione
    \begin{scope}
        \clip (t1) circle (1.5cm);
        \fill[yellow, opacity=0.3] (t2) circle (1.5cm);
    \end{scope}
    \node[nodo_testo] at (0,-2) {Area di potenziale collisione};
\end{tikzpicture}
\caption{Illustrazione di domini di collisione sovrapposti.}
\label{fig:collision_domain}
\end{figure}

\section{Classificazione dei Protocolli MAC Wireless}
I protocolli MAC possono essere classificati in base a come gestiscono l'accesso:

\begin{itemize}
    \item \textbf{Distributed Contention Based:} I nodi "competono" per accedere al canale.
    \begin{itemize}
        \item \textit{Deterministici:} L'accesso è determinato da un mapping di ID o un ordine fisso.
        \begin{itemize}
            \item Senza Coordinatore Centralizzato, allocazione statica delle risorse.
        \end{itemize}
        \item \textit{Probabilistici:} L'accesso è casuale, con meccanismi per risolvere le contese e le collisioni (es. ALOHA, CSMA).
        \begin{itemize}
            \item Senza Coordinatore Centralizzato, allocazione dinamica delle risorse.
            \item \textit{Esempio Pratico:} Pensa a una stanza affollata dove tutti vogliono parlare. Ognuno prova a parlare, e se due parlano insieme, si fermano, aspettano un tempo casuale e riprovano.
        \end{itemize}
    \end{itemize}
    \item \textbf{Contention Free:} L'accesso al canale è regolato per evitare collisioni.
    \begin{itemize}
        \item \textit{Dinamici Distribuiti:}
        \begin{itemize}
            \item \textit{Implicit Reservation}: L'uso riuscito del canale può implicare una prenotazione per usi futuri.
            \item \textit{Token Based}: Un "gettone" logico circola tra i nodi; solo chi ha il gettone può trasmettere.
            \item Senza Coordinatore Centralizzato, allocazione dinamica delle risorse.
        \end{itemize}
        \item \textit{Statici Centralizzati:}
        \begin{itemize}
            \item \textit{Reservation Based}: Un coordinatore centrale assegna slot di tempo/frequenza/codice.
            \item Esempi: TDMA (Time Division Multiple Access), FDMA (Frequency DMA), CDMA (Code DMA).
            \item Con Coordinatore Centralizzato, allocazione statica (o semi-statica) delle risorse.
            \item \textit{Esempio Pratico (TDMA):} Un insegnante (coordinatore) dà a ogni studente (nodo) un preciso intervallo di tempo in cui può fare una domanda.
        \end{itemize}
    \end{itemize}
    \item \textbf{Cluster-based MAC}: Protocolli ibridi che possono formare gruppi (cluster) con un coordinatore locale.
\end{itemize}

\begin{table}[H]
\centering
\begin{tabular}{|p{3cm}|p{3cm}|p{3cm}|p{3cm}|}
\hline
\rowcolor{bg_custom} \textbf{Caratteristica} & \textbf{Distributed Contention Based} & \textbf{Contention Free} & \textbf{Cluster-based} \\
\hline
\textbf{Coordinamento} & Nessun coordinatore centrale & Può essere con/senza coordinatore & Coordinatore locale per cluster \\
\hline
\textbf{Allocazione Risorse} & Dinamica (probabilistica) o Statica (deterministica) & Statica (centralizzata) o Dinamica (distribuita) & Ibrida \\
\hline
\textbf{Esempi} & ALOHA, CSMA & TDMA, FDMA, Token Ring & LEACH, HEED \\
\hline
\textbf{Vantaggi} & Semplice, adattivo & Garantisce QoS, no collisioni & Scalabile, efficiente energeticamente \\
\hline
\textbf{Svantaggi} & Possibili collisioni, overhead & Complessità, rigidità & Overhead di clustering \\
\hline
\end{tabular}
\caption{Confronto tra le principali classi di protocolli MAC wireless.}
\label{tab:mac_comparison}
\end{table}

\section{Prospettiva Evolutiva del MAC Distribuito (Dominio del Tempo)}
Si affronta il problema della \textit{vulnerabilità del frame} (rischio di collisione) e della necessità di una risoluzione distribuita.

\subsection{ALOHA}
Un nodo trasmette non appena ha dati. Se non riceve ACK, assume collisione e ritrasmette dopo backoff casuale.
\begin{itemize}
    \item \textbf{Tempo di vulnerabilità del frame = $2 \times \text{Tempo\_trasmissione\_frame}$.}
\end{itemize}

\begin{figure}[H]
\centering
\begin{tikzpicture}[nodo_base, font=\footnotesize, scale=0.8, transform shape]
    \node (ready) [nodo_base, diamond, aspect=2, fill=green!50!black] {Pacchetto pronto?};
    \node (transmit) [nodo_base, below=0.5cm of ready, fill=blue!50!black] {Trasmetti};
    \node (wait_ack) [nodo_base, below=0.5cm of transmit] {Attendi t round-trip};
    \node (ack_ok) [nodo_base, diamond, aspect=2, below=0.5cm of wait_ack, fill=green!50!black] {ACK positivo?};
    \node (delay_k) [nodo_base, right=2cm of transmit, fill=orange!50!black] {Ritarda trasmissione k volte};
    \node (backoff) [nodo_base, below=0.5cm of delay_k] {Calcola k casuale per backoff};

    % Collegamenti base
    \draw[linea] (ready) -- node[right, nodo_testo] {sì} (transmit);
    \draw[linea] (ready.north) -- node[right, nodo_testo] {no} ++(0,0.5) -| (ready.east);
    \draw[linea] (transmit) -- (wait_ack);
    \draw[linea] (wait_ack) -- (ack_ok);
    
    % Percorso ACK positivo - ora più chiaro e diretto
    \draw[linea] (ack_ok) -- node[left, nodo_testo] {sì} ++(-1.5,0) |- (ready);
    
    % Percorso ACK negativo
    \draw[linea] (ack_ok) -- node[above, nodo_testo] {no} (backoff);
    \draw[linea] (backoff) -- (delay_k);
    \draw[linea] (delay_k.north) |- (ready.north east);
\end{tikzpicture}
\caption{Diagramma di flusso del protocollo ALOHA.}
\label{fig:aloha_flow}
\end{figure}

\begin{figure}[H]
\centering
\begin{tikzpicture}[every node/.style={text=white, font=\scriptsize}]
    % Asse tempo
    \draw[linea] (0,2.5) -- (7,2.5) node[right] {time};
    \node at (-0.5,2) {STA i};
    \draw[linea_doppia, red] (1,2.7) -- (3,2.7) node[midway, above] {Frame size};
    \node[blocco_tempo_verde, minimum width=2cm] at (1,1.8) {frame1};
    \node[blocco_tempo_verde, minimum width=1cm] at (5.5,1.8) {ok1};

    \draw[linea] (0,1.3) -- (7,1.3) node[right] {time};
    \node at (-0.5,0.8) {STA j};
    \node[blocco_tempo, minimum width=1cm] at (0.5,0.6) {early1};
    \node[blocco_tempo, minimum width=1.5cm] at (2.5,0.6) {late2};
    \node[blocco_tempo_hatch, minimum width=1.5cm] at (4,0.6) {pkt2 (coll)}; % Assuming collision

    \draw[linea] (0,0.1) -- (7,0.1) node[right] {time};
    \node at (-1, -0.4) {Collision domain};
    \node[blocco_tempo, minimum width=1cm] at (0.5,-0.6) {early1};
    \node[blocco_tempo_verde, minimum width=2cm] at (1.5,-0.6) {Frame1};
    \node[blocco_tempo, minimum width=1.5cm] at (3.5,-0.6) {late2};
    \fill[red, opacity=0.3] (1.5,-0.6) rectangle (3.5,0); % Collision area
    \node[color=red] at (2.5, -1) {collision};
    \node[blocco_tempo_verde, minimum width=1cm] at (5.5,-0.6) {ok1};


    \draw[decorate, decoration={brace,mirror,amplitude=5pt}] (0.5,-1.5) -- (3.5,-1.5) node[midway, below=2pt] {Frame vulnerability time: twice the frame size};
    \draw[decorate,decoration={brace,mirror,amplitude=3pt}] (0.5,-0.7) -- (1.5,-0.7) node[midway,below=1pt,xshift=-5mm] {New1+frame1 coll.};
    \draw[decorate,decoration={brace,mirror,amplitude=3pt}] (1.5,-0.7) -- (3.5,-0.7) node[midway,below=8pt,xshift=5mm] {Frame1+New2 coll.};

\end{tikzpicture}
\caption{Vulnerabilità del frame in ALOHA.}
\label{fig:aloha_vuln}
\end{figure}


\subsection{Slotted ALOHA}
Il tempo è diviso in slot; trasmissione solo all'inizio di uno slot.
\begin{itemize}
    \item \textbf{Tempo di vulnerabilità del frame = $1 \times \text{Tempo\_trasmissione\_frame}$.}
\end{itemize}
Il diagramma di flusso è simile ad ALOHA, con l'aggiunta di "Wait for start of next slot" prima di trasmettere.

\begin{figure}[H]
\centering
\begin{tikzpicture}[every node/.style={text=white, font=\scriptsize}]
    % Asse tempo con slot
    \foreach \x in {1,2,...,6} {
        \draw[gray!50] (\x,2.8) -- (\x, -1);
    }
    \draw[linea] (0,2.5) -- (7,2.5) node[right] {time};
    \node at (-0.5,2) {STA i};
    \draw[<->, red] (1,2.7) -- (2,2.7) node[midway, above] {Framesize};
    \draw[<->, orange] (2,2.8) -- (2.5,2.8) node[midway, above, yshift=2pt] {Prop. delay};
    \node[blocco_tempo_verde, minimum width=1cm] at (1,1.8) {frame1};
    \node[blocco_tempo_verde, minimum width=1cm] at (2.5,1.8) {frame1 (tx)}; % Assuming retransmit or next

    \draw[linea] (0,1.3) -- (7,1.3) node[right] {time};
    \node at (-0.5,0.8) {STA j};
    \draw[<->, blue] (1,1.5) -- (2,1.5) node[midway, above] {time slot};
    \node[blocco_tempo, minimum width=1cm] at (1,0.6) {frame2};
    \node[blocco_tempo_hatch, minimum width=1cm] at (3.5,0.6) {frame2 (tx)};


    \draw[linea] (0,0.1) -- (7,0.1) node[right] {time};
    \node at (-1, -0.4) {Collision domain};
    \node[blocco_tempo_verde, minimum width=1cm] at (1,-0.6) {frame1};
    \fill[red, opacity=0.3] (1,-0.6) rectangle (2,0); % Collision frame2 started in same slot
    \node[color=red] at (1.5, -1.3) {collision};
    \node[blocco_tempo_verde, minimum width=1cm] at (2.5,-0.6) {frame1 (ok)}; % this frame1 is ok
    \node[blocco_tempo_hatch, minimum width=1cm] at (3.5,-0.6) {frame2 (ok)};

    \draw[decorate, decoration={brace,,mirror, amplitude=5pt}] (1,-1) -- (2,-1) node[midway, below=8pt] {Frame1+frame2 collision};
    \node at (3.5, -2) {Vulnerability time: frame size (slot + propagation)};
\end{tikzpicture}
\caption{Vulnerabilità del frame in Slotted ALOHA.}
\label{fig:slotted_aloha_vuln}
\end{figure}

\subsection{CSMA (Carrier Sense Multiple Access)}
Un nodo ascolta ("carrier sense") il canale prima di trasmettere.
\begin{itemize}
    \item \textbf{Problema:} Ritardo di propagazione.
    \item \textbf{Tempo di vulnerabilità del frame = $2 \times \text{Ritardo\_propagazione}$.}
\end{itemize}
Il diagramma di flusso aggiunge un controllo "Channel Busy?" prima di trasmettere.

\begin{figure}[H]
\centering
\begin{tikzpicture}[every node/.style={text=white, font=\scriptsize}]
    % Asse tempo
    \draw[linea] (0,2.5) -- (7,2.5) node[right] {time};
    \node at (-0.5,2) {STA i};
    \draw[<->, red] (1,2.7) -- (3,2.7) node[midway, above] {Frame size};
    \node[blocco_tempo_verde, minimum width=2cm] at (1,1.8) {frame1};
    \node[blocco_tempo_verde, pattern=north east lines, pattern color=gray, minimum width=2cm] at (3.5,1.8) {frame1 (tx)};

    \draw[linea] (0,1.3) -- (7,1.3) node[right] {time};
    \node at (-0.5,0.8) {STA j};
    \draw[<->, orange] (0.5,1.5) -- (1.5,1.5) node[midway, above] {Prop. delay};
    \node[blocco_tempo, minimum width=1cm] at (0.5,0.6) {early2};
    \node[blocco_tempo, minimum width=1cm] at (1.5,0.6) {late2}; % This one collides
    \node at (0,2.9) {Frame1 detected}; \draw[->, dashed, thick, red] (0.3,2.7) -- (1.5,1.9); % Moved Frame1 detected label and arrow

    \node[blocco_tempo_hatch, minimum width=1cm] at (4.5,0.6) {late2 (coll)};

    \draw[linea] (0,0.1) -- (7,0.1) node[right] {time};
    \node at (-1, -0.4) {Collision domain};
    \node[blocco_tempo, minimum width=1cm] at (0.5,-0.6) {early2};
    \node[blocco_tempo_verde, minimum width=0.5cm, fill=red!70!black] at (1.5,-0.6) {}; % Part of frame1
    \node[blocco_tempo, minimum width=1cm, fill=red!70!black, xshift=0.5cm] at (1.5,-0.6) {}; % late2 over part of frame1
    \node[blocco_tempo_verde, minimum width=1.5cm, xshift=1cm] at (1.5,-0.6) {}; % Rest of frame1
    \node[color=red] at (2,-0.75) {collision};
    \node[blocco_tempo_verde, pattern=north east lines, pattern color=gray, minimum width=2cm] at (3.5,-0.6) {frame1 (ok)};

    \draw[decorate,decoration={brace,amplitude=3pt,mirror}] (0.5,-0.9) -- (1.5,-0.9) node[midway,below=1pt,xshift=-6.5mm] {Frame1+early2 vuln.};
    \draw[decorate,decoration={brace,amplitude=3pt,mirror}] (1.5,-0.9) -- (2.5,-0.9) node[midway,below=1pt,xshift=6.5mm] {Frame1+late2 vuln.};
    \node at (3.5, -2.4) {Frame vulnerability time: twice the propagation delay};
\end{tikzpicture}
\caption{Vulnerabilità del frame in CSMA.}
\label{fig:csma_vuln}
\end{figure}

\subsection{Slotted CSMA}
Combina CSMA con slot temporali.
\begin{itemize}
    \item \textbf{Tempo di vulnerabilità del frame = $1 \times \text{Ritardo\_propagazione}$.}
\end{itemize}

\subsection{CSMA/CD (Collision Detection)}
Ascolta prima e durante la trasmissione. Non pratico in wireless.

\subsection{CSMA/CA (Collision Avoidance)}
Tecnica principale nelle reti wireless. Include risoluzione e controllo delle contese.

\subsection{Comparazione del Throughput}
Un grafico tipico (Figura \ref{fig:throughput_comparison}) mostra che, in termini di throughput massimo:
Slotted CSMA > Pure CSMA > Slotted ALOHA > Pure ALOHA.
Tutti questi protocolli soffrono di un calo di throughput ad alto carico.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{images/throughput_comparison.png}
\caption{Comparazione teorica del throughput per diversi protocolli MAC.}
\label{fig:throughput_comparison}
\end{figure}


\section{Prospettiva Evolutiva del MAC Distribuito (Dominio dello Spazio)}
Affronta problemi come il terminale nascosto e esposto. Soluzione principale: RTS/CTS.

\subsection{Problema del Terminale Nascosto e Esposto}
\begin{itemize}
    \item \textbf{Terminale Nascosto:} A e C non si sentono, ma entrambi vogliono trasmettere a B. Collisione su B.
    \begin{itemize}
        \item \textbf{Soluzione con RTS/CTS:} A invia RTS a B. B risponde con CTS. C sente CTS e si astiene.
    \end{itemize}
    \item \textbf{Terminale Esposto:} B trasmette ad A. C (nel raggio di B) vuole trasmettere a D (fuori dal raggio di B). C sente B e non trasmette, sprecando un'opportunità.
\end{itemize}

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=0.7]
    % Define styles
    \tikzstyle{station}=[circle, draw, fill=white, text=black, minimum size=10mm, font=\large, thick]
    \tikzstyle{linea}=[->]
    \tikzstyle{rts_arrow}=[thick, blue]
    \tikzstyle{cts_arrow}=[thick, green]
    \tikzstyle{interference_range}=[dashed, red, thick, opacity=0.7]
    \tikzstyle{transmission_range}=[dashed, gray, thick, opacity=0.5]
    \tikzstyle{nodo_testo}=[font=\small, align=center]
    \tikzstyle{legend_box}=[draw, fill=bg_custom, opacity=0.9]

    % Main scenario title
    \node at (0, 5) {\textbf{Asimmetria di Potenza RTS/CTS}};

    % Stations
    \node (A) [station, fill=pink!30] at (-3, 2) {A};
    \node (C) [station, fill=green!30] at (0, 2) {C};
    \node (B) [station, fill=blue!30] at (3, 2) {B};
    \node (D) [station, fill=orange!30] at (0, -1) {D};

    % Transmission ranges (smaller circles)
    \draw[transmission_range] (A) circle (1.8cm);
    \draw[transmission_range] (C) circle (1.8cm);
    \draw[transmission_range] (B) circle (1.8cm);
    \draw[transmission_range] (D) circle (1.8cm);

    % Interference ranges (larger circles)
    \draw[interference_range] (A) circle (2.5cm);
    \draw[interference_range] (C) circle (2.5cm);
    \draw[interference_range] (B) circle (2.5cm);
    \draw[interference_range] (D) circle (2.5cm);

    % RTS/CTS communication
    \draw[rts_arrow, linea, bend left=15] (A) to (C);
    \draw[cts_arrow, linea, bend left=15] (C) to (A);
    
    % CTS broadcast
    \draw[cts_arrow, linea, dashed] (C) -- (B);
    
    % Problem arrows showing interference
    \draw[red, thick, linea, dashed] (D) -- (C);
    \draw[red, thick, linea, dashed] (C) -- (D);

    % Comprehensive Legend (moved to right)
    \node[legend_box, anchor=north west] at (4, -2) {
        \begin{tabular}{ll}
            \textbf{Frecce:} & \textbf{Raggi:} \\
            \textcolor{blue}{$\rightarrow$} RTS & \tikz\draw[transmission_range] (0,0) -- (0.4,0); Trasmissione \\
            \textcolor{green}{$\rightarrow$} CTS & \tikz\draw[interference_range] (0,0) -- (0.4,0); Interferenza \\
            \textcolor{red}{$\dashrightarrow$} Interferenza & \\
            \textcolor{green}{$\dashrightarrow$} Diffusione CTS & \\
        \end{tabular}
    };

    % RTS Collision Example (right side)
    \node at (12, 3.5) {\textbf{Esempio di Collisione RTS}};
    
    % Nodes for collision scenario
    \node (A2) [station, fill=pink!30] at (10, 1.5) {A};
    \node (B2) [station, fill=blue!30] at (12, 0.5) {B};
    \node (C2) [station, fill=green!30] at (14, 1.5) {C};
    
    % Transmission ranges
    \draw[transmission_range] (A2) circle (1.5cm);
    \draw[transmission_range] (C2) circle (1.5cm);
    
    % Simultaneous RTS collision
    \draw[red, thick, linea] (A2) -- (B2);
    \draw[red, thick, linea] (C2) -- (B2);
    
    % Collision indicator
    \node[red, font=\small] at (12, -0.69) {COLLISIONE};

\end{tikzpicture}
\caption{Svantaggi di RTS/CTS: asimmetria di potenza e collisioni RTS. Il nodo D si trova nel raggio di interferenza di C ma potrebbe non sentire il CTS, causando interferenze non necessarie e perdita di opportunità di trasmissione. L'asimmetria di potenza tra raggio di trasmissione e interferenza crea questa problematica. A destra, un esempio di collisione RTS quando due nodi inviano simultaneamente RTS allo stesso destinatario.}
\label{fig:rts_cts_drawbacks}
\end{figure}

\subsection{Evoluzione dei Protocolli basati su RTS/CTS}
\begin{itemize}
    \item \textbf{MACA (Multiple Access with Collision Avoidance):} RTS/CTS, no carrier sense. Contesa sul ricevitore.
    \item \textbf{MACAW (MACA for Wireless):} No carrier sense, introduce ACK esplicito (RTS-CTS-DATA-ACK). Backoff MILD/BEB.
    \item \textbf{FAMA (Floor Acquisition Multiple Access):} Reintroduce carrier sense prima di RTS/CTS. Concetto di "floor acquisition".
\end{itemize}
I diagrammi per MACA, MACAW e FAMA (slide 18-20) sono simili a Figura \ref{fig:hidden_terminal_rts_cts} (scenario a destra), con l'aggiunta/rimozione del carrier sense e dell'ACK.

\section{Problemi Tempo/Spazio in Reti Ad Hoc Multi-hop}
In catene multi-hop (A->B->C), sorgono problemi di auto-contesa:
\begin{itemize}
    \item \textbf{Auto-contesa Inter-stream:} Dati (A->B) vs ACK (B->A) attorno a B.
    \item \textbf{Auto-contesa Intra-stream:} B riceve da A e trasmette a C; la sua trasmissione può interferire con la ricezione.
    \item \textbf{Coordinazione:} Soluzioni proposte includono fast forward, quick exchange, flow numbering.
\end{itemize}

\section{CSMA/CA: Lo Standard IEEE 802.11 (Wireless LAN)}
Un protocollo MAC con due funzioni di coordinamento in una struttura di superframe:
\begin{itemize}
    \item \textbf{DCF (Distributed Coordination Function):} Base, obbligatoria. Reti Ad-Hoc e contesa. Controllo distribuito, CSMA/CA con BEB.
    \item \textbf{PCF (Point Coordination Function):} Opzionale. Richiede Point Coordinator (AP). Controllo centralizzato, polling, QoS "soft".
\end{itemize}

\subsection{Architettura del Protocollo MAC IEEE 802.11}
\begin{figure}[H]
\centering
\begin{tikzpicture}[
    layer/.style={rectangle, draw=black, thick, text=white, font=\footnotesize, text centered, minimum height=1cm},
    service/.style={rectangle, rounded corners=8pt, draw=black, thick, text=black, font=\footnotesize, text centered, minimum height=0.8cm},
    arrow/.style={->, thick, >=stealth},
    node distance=0.8cm
]
    % Upper layer services (top)
    \node[service, fill=red!20, minimum width=3.8cm] (contention_serv) {
        \parbox{3.5cm}{\centering \textbf{Servizi Basati su Contesa} \\ \small Best effort, senza garanzie}
    };
    
    \node[service, fill=blue!20, minimum width=3.8cm, right=0.8cm of contention_serv] (contention_free_serv) {
        \parbox{3.5cm}{\centering \textbf{Servizi Senza Contesa} \\ \small Vincoli temporali, supporto QoS}
    };
    
    % MAC Layer components
    \node[layer, fill=cyan!70, minimum width=3.8cm, below=1.2cm of contention_serv] (dcf) {
        \parbox{3.5cm}{\centering \textbf{Funzione di Coordinamento Distribuito (DCF)} \\ \small CSMA/CA, Accesso Casuale}
    };
    
    \node[layer, fill=green!70, minimum width=3.8cm, below=1.2cm of contention_free_serv] (pcf) {
        \parbox{3.5cm}{\centering \textbf{Funzione di Coordinamento Centralizzato (PCF)} \\ \small Accesso basato su Polling}
    };
    
    % MAC Sublayer container
    \draw[thick] ([xshift=-0.3cm, yshift=0.3cm]dcf.north west) rectangle ([xshift=0.3cm, yshift=-0.3cm]pcf.south east);
    \node[left=1cm of dcf.west, font=\small, rotate=90] {MAC SUBLAYER};
    
    % Physical Layer (bottom)
    \node[layer, fill=orange!70, minimum width=8.7cm, below=1.5cm of dcf] (phy) {
        \parbox{8cm}{\centering \textbf{Strato Fisico (PHY)} \\ \small Trasmissione radio, modulazione, codifica}
    };
    
    % Connection arrows
    \draw[arrow, red!70, line width=1.5pt] (contention_serv.south) -- (dcf.north);
    \draw[arrow, blue!70, line width=1.5pt] (contention_free_serv.south) -- (pcf.north);
    
    % Layer separation line
    \draw[dashed, gray, thick] ([xshift=-4.5cm, yshift=0.4cm]phy.north) -- ([xshift=4.5cm, yshift=0.4cm]phy.north);
    
    % Side annotation for access methods
    \node[align=left, font=\footnotesize, anchor=west] at ([xshift=0.8cm]pcf.east) {
        \textbf{Metodi di Accesso:}\\
        • DCF: Accesso casuale\\
        • PCF: Controllo centralizzato
    };
\end{tikzpicture}
\caption{Architettura del protocollo MAC IEEE 802.11 - Struttura a livelli e funzioni di coordinamento.}
\label{fig:mac_architecture}
\end{figure}

\subsection{Point Coordinated Mode (PCF)}
Servizio opzionale, senza contesa, gestito dall'AP (Point Coordinator) tramite Beacon e polling durante il CFP (Contention Free Period).
\begin{figure}[H]
\centering
\begin{tikzpicture}[every node/.style={text=white, font=\small}]
    % Superframe structure
    \draw (0,1) -- (10,1);
    \draw (0,0) -- (10,0);

    \node[rectangle, draw, fill=gray!50!black, minimum height=1cm, minimum width=0.5cm, anchor=south west] (b1) at (0,0) {B};
    \node[rectangle, draw, fill=green!50!black, minimum height=1cm, minimum width=2cm, anchor=south west] (pcf1) at (0.5,0) {PCF};
    \node[rectangle, draw, fill=cyan!50!black, minimum height=1cm, minimum width=2cm, anchor=south west] (dcf1) at (2.5,0) {DCF};

    \node[rectangle, draw, fill=gray!50!black, minimum height=1cm, minimum width=0.5cm, anchor=south west] (b2) at (5,0) {B};
    \node[rectangle, draw, fill=green!50!black, minimum height=1cm, minimum width=2cm, anchor=south west] (pcf2) at (5.5,0) {PCF};
    \node[rectangle, draw, fill=cyan!50!black, minimum height=1cm, minimum width=2cm, anchor=south west] (dcf2) at (7.5,0) {DCF};

    \draw[<->] (0,1.2) -- (2.5,1.2) node[midway, above] {CFP};
    \draw (2.5,1.2) -- (4.5,1.2) node[midway, above] {CP}; % CFP Repetition Interval
    \draw[<->] (0,1.8) -- (5,1.8) node[midway, above] {CFP Repetition Interval};
    \draw[<->] (5,1.8) -- (10,1.8) node[midway, above] {CFP Repetition Interval};


    % NAV
    \node[rectangle, draw, fill=orange!60!black, minimum height=0.5cm, minimum width=2.5cm, anchor=south west] (nav1) at (0,-1) {NAV};
    \node[rectangle, draw, fill=orange!60!black, minimum height=0.5cm, minimum width=2.5cm, anchor=south west] (nav2) at (5,-1) {NAV};
    \node at (2.5,-1.5) {NAV (Network Allocation Vector) indica canale occupato};
\end{tikzpicture}
\caption{Struttura del Superframe IEEE 802.11 con PCF e DCF, e NAV.}
\label{fig:superframe_nav}
\end{figure}

\subsection{Controllo DCF e PCF: Interframe Spaces (IFS)}
Priorità di accesso gestita da intervalli: SIFS < PIFS < DIFS.
\begin{figure}[H]
\centering
\begin{tikzpicture}[font=\small, scale=0.85, transform shape]
    % Timeline
    \draw[linea] (0,0) -- (14,0);

    % Scenario 1: DCF only
    \node[nodo_testo, above=0.8cm of {(-0.5,0)}] {DCF time (scenario 1: no PCF takes control)};
    \node[blocco_tempo_verde, minimum width=2cm] (dcf_t1) at (0,-0.3) {DCF Trans. 1};
    \node[blocco_tempo, minimum width=0.5cm] (sifs1) at ($(dcf_t1.south east)+(0.05,0)$) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1cm] (ack1) at ($(sifs1.south east)+(0.05,0)$) {ack};
    \node[blocco_tempo, minimum width=1cm, fill=purple!60!black] (difs1) at ($(ack1.south east)+(0.05,0)$) {DIFS};
    \node[blocco_tempo_hatch, minimum width=1.5cm] (backoff1) at ($(difs1.south east)+(0.05,0)$) {Backoff};
    \node[blocco_tempo_verde, minimum width=2cm] (dcf_t2) at ($(backoff1.south east)+(0.05,0)$) {DCF Trans. 2};
    \node[blocco_tempo, minimum width=0.5cm] (sifs2) at ($(dcf_t2.south east)+(0.05,0)$) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1cm] (ack2) at ($(sifs2.south east)+(0.05,0)$) {ack};
    \node[blocco_tempo, minimum width=1cm, fill=purple!60!black] (difs2) at ($(ack2.south east)+(0.05,0)$) {DIFS};
    \node[blocco_tempo_verde, minimum width=1cm, fill=yellow!60!black] at ($(difs2.south east)+(0.05,0)$) {DCF};

    % Scenario 2: PCF takes control
    \node[nodo_testo, above=0.8cm of {(0, -1.8)}] {PCF (polling based) time (scenario 2)};
    \node[blocco_tempo, fill=orange!60!black, minimum width=0.8cm] (poll_start) at (0,-2.1) {Poll}; % Start of PCF
    \node[blocco_tempo, minimum width=0.5cm] (sifs_pcf1) at ($(poll_start.south east)+(0.05,0)$) {SIFS};
    \node[blocco_tempo_verde, minimum width=1.5cm] (pcf_t1) at ($(sifs_pcf1.south east)+(0.05,0)$) {Poll trans. 1};
    \node[blocco_tempo, minimum width=0.5cm] (sifs_pcf2) at ($(pcf_t1.south east)+(0.05,0)$) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1cm] (ack_pcf1) at ($(sifs_pcf2.south east)+(0.05,0)$) {ack};
    \node[blocco_tempo, minimum width=0.8cm, fill=gray!60!black] (pifs1) at ($(ack_pcf1.south east)+(0.05,0)$) {PIFS}; % AP waits PIFS
    \node[blocco_tempo_verde, minimum width=1.5cm] (pcf_t2) at ($(pifs1.south east)+(0.05,0)$) {Poll trans. 2};
    \node[blocco_tempo, minimum width=0.5cm] (sifs_pcf3) at ($(pcf_t2.south east)+(0.05,0)$) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1cm] (ack_pcf2) at ($(sifs_pcf3.south east)+(0.05,0)$) {ack};
    \node[blocco_tempo, minimum width=1cm, fill=purple!60!black] (difs_after_pcf) at ($(ack_pcf2.south east)+(0.05,0)$) {DIFS: restart DCF};
    \node[blocco_tempo_verde, minimum width=1cm, fill=yellow!60!black] at ($(difs_after_pcf.south east)+(0.55,0)$) {DCF};

    % Legenda
    \node[rectangle, fill=green!60!black, label={[text=white, font=\small]right:DCF/PCF Transmit}, minimum size=0.3cm] at (0,-3.5) {};
    \node[rectangle, fill=blue!70!black, label={[text=white, font=\small]right:SIFS}, minimum size=0.3cm] at (3,-3.5) {};
    \node[rectangle, fill=red!70!black, label={[text=white, font=\small]right:ACK/Poll}, minimum size=0.3cm] at (5,-3.5) {};
    \node[rectangle, fill=purple!60!black, label={[text=white, font=\small]right:DIFS}, minimum size=0.3cm] at (7.5,-3.5) {};
    \node[rectangle, fill=gray!60!black, label={[text=white, font=\small]right:PIFS}, minimum size=0.3cm] at (9.5,-3.5) {};
    \node[rectangle, pattern=north east lines, pattern color=gray, label={[text=white, font=\small]right:Backoff (contention)}, minimum size=0.3cm] at (11.5,-3.5) {};
\end{tikzpicture}
\caption{Controllo DCF e PCF tramite Interframe Spaces (IFS).}
\label{fig:ifs_control}
\end{figure}

\subsection{Distributed Coordination Function (DCF) in dettaglio}
Modalità CSMA/CA con Backoff Esponenziale Binario (BEB) su tempo idle slottato.
\begin{figure}[H]
\centering
\begin{tikzpicture}[font=\small, transform shape]
    % Timeline
    \draw[linea] (0,0) -- (12,0);
    \node[blocco_tempo, minimum width=2cm, fill=orange!60!black] (busy) at (0,-0.3) {Medium Busy};
    \node[blocco_tempo, minimum width=1cm, fill=purple!60!black] (difs) at ($(busy.south east)+(0.1,0)$) {DIFS};

    % Backoff slots
    \node (backoff_start) at ($(difs.east)+(0.1,0.15)$) {};
    \foreach \i [count=\xi from 1] in {1,...,4} {
        \node (s\xi) [blocco_tempo, minimum width=0.5cm, fill=gray!60!black, minimum height=0.2cm, anchor=west] at ($(backoff_start)+(\i*0.6-0.6,0)$) {Slot \xi};
        \draw[gray!70] (s\xi.south west) -- ++(0,-0.4);
        \ifnum\xi=4
             \node (backoff_end) at (s\xi.east) {};
        \fi
    }
    \draw[decorate, decoration={brace,amplitude=8pt,mirror}] ($(backoff_start)+(0,-0.2)$) -- ($(backoff_end)+(0,-0.2)$) node[midway, below=8pt] {Backoff period};
    \node[blocco_tempo_verde, minimum width=3cm] (pkt_tx) at ($(backoff_end)+(0.1,-0.3)$) {Packet Transmitted};
    \node[blocco_tempo, minimum width=0.5cm] (sifs_ack) at ($(pkt_tx.south east)+(0.1,0)$) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1cm] (ack_rx) at ($(sifs_ack.south east)+(0.1,0)$) {ACK};
\end{tikzpicture}
\caption{Funzionamento base del DCF con backoff.}
\label{fig:dcf_basic}
\end{figure}

\subsection{Meccanismo di Accesso CSMA/CA (DCF)}
\begin{enumerate}
    \item \textbf{Medium Busy:} Se canale occupato, attendi che si liberi.
    \item \textbf{DIFS:} Attendi DIFS.
    \item \textbf{Back-off Window:} Scegli slot casuali da CW, decrementa contatore se canale libero, congela se occupato.
    \item \textbf{Packet Transmitted:} Trasmetti quando contatore è zero.
\end{enumerate}

\subsection{Procedura di Backoff DCF}
\begin{itemize}
    \item \textbf{Selezione Tempo di Backoff Casuale:} $\text{BackoffTime} = \text{random}(0, \text{CW}_i - 1) \times \text{SlotTime}$.
    $\text{CW}_i$ (Contention Window) raddoppia dopo ogni collisione ($\text{CW}_{\min} \le \text{CW}_i \le \text{CW}_{\max}$).
    \begin{center}
    \begin{tabular}{|c|c|c|c|c|c|c|c|}
        \hline
        \textbf{i} & 1 & 2 & 3 & 4 & 5 & 6 & 7 \\ \hline
        $\mathbf{CW_i}$ & 15 & 31 & 63 & 127 & 255 & 511 & 1023 \\ \hline
    \end{tabular}
    \end{center}
    (Valori $\text{CW}_{\min}$ tipici possono essere 15 o 31 a seconda dello standard fisico)
    \item \textbf{Riduzione Tempo di Backoff:} Dopo DIFS, decrementa per ogni slot idle.
    \item \textbf{Congelamento (Frozen):} Se mezzo occupato, sospendi backoff.
    \item \textbf{Trasmissione:} A backoff zero, trasmetti.
\end{itemize}

\subsection{DCF Basic Access: Panoramica}
\begin{itemize}
    \item \textbf{Trasmissione Riuscita:} Sorgente (DIFS, Backoff, DATA) -> Destinazione (SIFS, ACK).
    \item \textbf{Collisione (senza CD):} Pacchetti collidono. Lunghezza collisione = $\max(L_A, L_B, L_C, \dots)$. Mancanza di ACK segnala collisione.
\end{itemize}

\begin{figure}[H]
\centering
\begin{tikzpicture}[
    font=\small, 
    scale=0.9, 
    transform shape,
    % Define styles
    blocco_tempo/.style={rectangle, draw, thick, minimum height=0.4cm, anchor=south west},
    blocco_tempo_verde/.style={blocco_tempo, fill=green!40},
    blocco_tempo_rosso/.style={blocco_tempo, fill=red!40},
    linea/.style={thick},
    nodo_testo/.style={font=\small\bfseries}
]
    % SUCCESS SCENARIO - Moved up and left
    \node[nodo_testo, anchor=west] at (0, 3) {\textbf{Successful transmission:}};
    
    % Source timeline - Moved down
    \draw[linea] (0, 2.3) -- (10, 2.3);
    \node[left] at (0, 2.3) {Source};
    
    % Source blocks with proper spacing
    \node[blocco_tempo, fill=purple!60, minimum width=1.2cm] (difs1) at (0.5, 2.3) {DIFS};
    \node[blocco_tempo, fill=gray!40, minimum width=1.5cm] (backoff) at ([xshift=0.2cm]difs1.south east) {Backoff};
    \node[blocco_tempo_verde, minimum width=2.5cm] (data) at ([xshift=0.2cm]backoff.south east) {DATA};
    
    % Destination timeline - Increased spacing from Source  
    \draw[linea] (0, 1.3) -- (10, 1.3);
    \node[left] at (0, 1.3) {Destination};
    
    % Destination blocks aligned properly
    \coordinate (data_end) at (data.south east);
    \node[blocco_tempo, fill=yellow!60, minimum width=0.8cm] (sifs) at ([xshift=0.2cm]data_end |- 0,1.3) {SIFS};
    \node[blocco_tempo_rosso, minimum width=1.2cm] (ack) at ([xshift=0.2cm]sifs.south east) {ACK};
    
    % COLLISION SCENARIO - Increased spacing
    \node[nodo_testo, anchor=west] at (0, 0) {\textbf{Collision: no CD}};
    
    % Station A - Increased spacing
    \draw[linea] (0, -0.7) -- (10, -0.7);
    \node[left] at (0, -0.7) {Station A};
    \node[blocco_tempo, fill=purple!60, minimum width=1.2cm] (difs_a) at (0.5, -0.7) {DIFS};
    \node[blocco_tempo, fill=gray!40, minimum width=1cm] (backoff_a) at ([xshift=0.2cm]difs_a.south east) {BO};
    \node[blocco_tempo_verde, minimum width=3cm] (la) at ([xshift=0.2cm]backoff_a.south east) {$L_A$};
    
    % Station B - Increased spacing  
    \draw[linea] (0, -1.8) -- (10, -1.8);
    \node[left] at (0, -1.8) {Station B};
    \node[blocco_tempo, fill=purple!60, minimum width=1.2cm] (difs_b) at (0.5, -1.8) {DIFS};
    \node[blocco_tempo, fill=gray!40, minimum width=1.5cm] (backoff_b) at ([xshift=0.2cm]difs_b.south east) {BO};
    \node[blocco_tempo, fill=blue!60, minimum width=2cm] (lb) at ([xshift=0.2cm]backoff_b.south east) {$L_B$};
    
    % Station C - Increased spacing
    \draw[linea] (0, -2.9) -- (10, -2.9);
    \node[left] at (0, -2.9) {Station C};
    \node[blocco_tempo, fill=purple!60, minimum width=1.2cm] (difs_c) at (0.5, -2.9) {DIFS};
    \node[blocco_tempo, fill=gray!40, minimum width=2cm] (backoff_c) at ([xshift=0.2cm]difs_c.south east) {BO};
    \node[blocco_tempo, fill=orange!60, minimum width=1.5cm] (lc) at ([xshift=0.2cm]backoff_c.south east) {$L_C$};
    
    % Find collision boundaries
    \coordinate (coll_start) at (backoff_a.south east);
    \coordinate (coll_end) at (la.south east);
    
    % Collision length brace - Moved down significantly
    \draw[decorate, decoration={brace, amplitude=6pt}] 
        ([yshift=0.7cm]coll_start) -- ([yshift=0.7cm]coll_end) 
        node[midway, above=6pt, align=center] {COLLISION LENGTH\\= max($L_A, L_B, L_C$)};
    
    % No carrier detection note - Adjusted position
    \node[nodo_testo, color=red, align=center] at ([xshift=1cm, yshift=-1cm]coll_end) {IEEE 802.11\\no CD};
    
    % Add arrows to show transmission direction
    \draw[->, thick, red] ([yshift=0.1cm]data.north) -- ([yshift=0.1cm]data.north east);
    \draw[->, thick, blue] ([yshift=0.1cm]ack.north) -- ([yshift=0.1cm]ack.north west);
    
\end{tikzpicture}
\caption{DCF: Trasmissione riuscita e scenario di collisione.}
\label{fig:dcf_overview}
\end{figure}

\subsection{Controllo della Contesa in IEEE 802.11}
Alta contesa porta a molte collisioni e basso utilizzo del canale. Il BEB cerca di mitigare ciò.
Un grafico tipico (Figura \ref{fig:contention_control}) mostra che l'utilizzo del canale diminuisce all'aumentare del numero di stazioni.

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{images/contention_control.png}
\caption{Effetto della contesa sull'utilizzo del canale in IEEE 802.11 DCF.}
\label{fig:contention_control}
\end{figure}

\end{document}